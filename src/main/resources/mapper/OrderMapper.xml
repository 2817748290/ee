<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
                PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
                "http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.liangliang.bookmanager.mapper.OrderMapper">
    <resultMap id="OrderMap" type="com.liangliang.bookmanager.bean.Order">
        <id column="order_id" property="orderId"/>
        <result column="borrower_id" property="borrowerId"/>
        <result column="book_id" property="bookId"/>
        <result column="status" property="status"/>
        <result column="create_date" property="createDate"/>
        <result column="update_date" property="updateDate"/>
    </resultMap>

    <select id="getOrderList"  resultMap="OrderMap">
        SELECT * FROM `order` u
    </select>
    <select id="getOrderById"  resultMap="OrderMap">
        SELECT * FROM `book` u WHERE `order_id` = #{_parameter}
    </select>
    <select id="searchOrder" resultMap="OrderMap">
        SELECT o.*,u.`username`,b.`book_name` FROM `order` o LEFT JOIN `user` u ON u.`user_id` =  o.`borrower_id`
        LEFT JOIN `book` b ON b.`book_id` = o.`book_id`
    </select>
    <select id="searchOrderCount" resultType="Integer">
        SELECT COUNT(*) FROM `order` o LEFT JOIN `user` u ON u.`user_id` =  o.`borrower_id`
        LEFT JOIN `book` b ON b.`book_id` = o.`book_id`
    </select>
    <insert id="addOrder" parameterType="com.liangliang.bookmanager.bean.Order">
        INSERT INTO `order` (`ordername`,`password`,`nickname`,`points`,`group`,`order_state`,`email`)
        SELECT #{ordername},#{password},#{nickname},#{points},#{group},#{orderState},#{email} FROM DUAL
        WHERE NOT EXISTS(SELECT 1 FROM(SELECT 1 FROM `order` WHERE `ordername`=#{ordername})a)
    </insert>
    <update id="updateOrder" parameterType="com.liangliang.bookmanager.bean.Order">
        UPDATE `order`
        <set>
            <if test="ordername != null">
                `ordername` = #{ordername},
            </if>
            <if test="password != null">
                `password`=#{password},
            </if>
            <if test="nickname != null">
                `nickname` = #{nickname},
            </if>
            <if test="group != null">
                `group` = #{group},
            </if>
            <if test="points != null">
                `points`= #{points},
            </if>
            <if test="orderState != null">
                `order_state` = #{orderState},
            </if>
            <if test="email != null">
                `email` = #{email}
            </if>
        </set>
        where order_id=#{orderId}
        <if test="ordername != null">
            and not exists(select 1 from(select 1 from `order` where `ordername`=#{ordername})a)
        </if>
    </update>

    <delete id="deleteOrder">
        DELETE FROM `order`
        WHERE `order_id`=#{_parameter}
    </delete>

</mapper>